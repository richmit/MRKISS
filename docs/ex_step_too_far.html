<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2025-09-05 Fri 17:01 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=1024, initial-scale=1" />
<title>Runge-Kutta Step Size and Accuracy</title>
<meta name="author" content="Mitch Richling" />
<meta name="description" content="MRKISS Documentation Examples" />
<meta name="keywords" content="RK runge kutta ode ivp" />
<meta name="generator" content="Org Mode" />
<style type="text/css">
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<style>body { width: 95%; margin: 2% auto; font-size: 18px; line-height: 1.4em; font-family: Georgia, serif; color: black; background-color: white; }</style>
<style>body { min-width: 500px; max-width: 1024px; }</style>
<style>h1,h2,h3,h4,h5,h6 { color: #A5573E; line-height: 1em; font-family: Helvetica, sans-serif; }</style>
<style>h1,h2,h3 { line-height: 1.4em; }</style>
<style>h1.title { font-size: 3em; }</style>
<style>.subtitle { font-size: 0.6em; }</style>
<style>h4,h5,h6 { font-size: 1em; }</style>
<style>.org-src-container { border: 1px solid #ccc; box-shadow: 3px 3px 3px #eee; font-family: Lucida Console, monospace; font-size: 80%; margin: 0px; padding: 0px 0px; position: relative; }</style>
<style>.org-src-container>pre { line-height: 1.2em; padding-top: 1.5em; margin: 0.5em; background-color: #404040; color: white; overflow: auto; }</style>
<style>.org-src-container>pre:before { display: block; position: absolute; background-color: #b3b3b3; top: 0; right: 0; padding: 0 0.2em 0 0.4em; border-bottom-left-radius: 8px; border: 0; color: white; font-size: 100%; font-family: Helvetica, sans-serif;}</style>
<style>pre.example { white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -o-pre-wrap; font-family: Lucida Console, monospace; font-size: 80%; background: #404040; color: white; display: block; padding: 0em; border: 2px solid black; }</style>
<style>blockquote { margin-bottom: 0.5em; padding: 0.5em; background-color: #FFF8DC; border-left: 2px solid #A5573E; border-left-color: rgb(255, 228, 102); display: block; margin-block-start: 1em; margin-block-end: 1em; margin-inline-start: 5em; margin-inline-end: 5em; } </style>
<style>#content { max-width: 60em; }</style>
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="https://github.com/richmit/MRKISS/"> UP </a>
 |
 <a accesskey="H" href="https://www.mitchr.me/"> HOME </a>
</div><div id="content" class="content">
<h1 class="title">Runge-Kutta Step Size and Accuracy
<br />
<span class="subtitle">A MRKISS Library Example Program</span>
</h1>
<table border="2 solid #ccc" cellspacing="0" cellpadding="6" rules="groups" frame="hsides" align="center">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-right"><b>Author:</b></td>
<td class="org-left"><i>Mitch Richling</i></td>
</tr>

<tr>
<td class="org-right"><b>Updated:</b></td>
<td class="org-left"><i>2025-09-04 13:34:20</i></td>
</tr>

<tr>
<td class="org-right"><b>Generated:</b></td>
<td class="org-left"><i>2025-09-05 17:01:23</i></td>
</tr>
</tbody>
</table>
<p align="center">
Copyright &copy; 2025 Mitch Richling. All rights reserved.
</p>

<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#Results">1. Results</a></li>
<li><a href="#full-code">2. Full Code Listing</a>
<ul>
<li><a href="#fortrancode">2.1. Fortran Code</a></li>
<li><a href="#rcode">2.2. R Code</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-Results" class="outline-2">
<h2 id="Results"><span class="section-number-2">1.</span> Results</h2>
<div class="outline-text-2" id="text-Results">
<p>
The code for this example is found in <a href="https://github.com/richmit/MRKISS/blob/master/examples/step_too_far.f90"><code>examples/step_too_far.f90</code></a>.
Additionally the code may be found at the end of this document in the section <a href="#full-code">Full Code Listing</a>.
</p>

<div class="org" id="orgccdc1aa">
<p>
In this example we solve a simple equation with various step sizes in order to observe the relationship between step size and
accuracy.
</p>

<p>
The system we solve:
   \[ y'(t)=e^t + y(t) \,\,\,\mathrm{with}\,\,\, y(0)=0 \]
</p>

<p>
We can solve this equation symbolically:
   \[ y(t) = te^t  \]
</p>

<p>
By construction, the truncation error for an RK method decreases as the step size decreases.  Round-off error on the other
hand increases as the step size decreases.  Total error is the sum of truncation and round-off error.  In this experiment we
directly measure total error.  For moderate step sizes we observe truncation error dominating the total error.  As the step
size gets smaller, we see the total error continue to improve as expected; however, the nice smooth response curve begins to
roughen up a bit with what looks like random noise.  Eventually we reach small enough step sizes that round-off error begins
to dominate the results, and accuracy degrades as step size continues to decrease. The point at which this happens is very
much dependent upon the RK method, the problem, and how both are is implemented.
</p>

</div>

<p>
Here is a log-log plot of our measured results:
</p>


<div id="orgaf3ebd5" class="figure">
<p><img src="pics/step_too_far.png" alt="step_too_far.png" width="90%" align="center" />
</p>
</div>

<p>
We can statistically decompose the total error into truncation and round-off components.  The results look 
something like this:
</p>


<div id="orgff52fc9" class="figure">
<p><img src="pics/step_too_far_mean.png" alt="step_too_far_mean.png" width="90%" align="center" />
</p>
</div>

<p>
In the above graph notice the distinct difference between the behavior of truncation and round-off errors in terms of variance in the residual distribution.
While it is not always the case, it's a pretty common occurrence to see higher variance in round-off error than truncation error in practice.
</p>


<div id="org0e8cc25" class="figure">
<p><img src="pics/step_too_far_trdst.png" alt="step_too_far_trdst.png" width="90%" align="center" />
</p>
</div>

<p>
Truncation error only impacts the accuracy of \(\mathbf{y}\), but round-off error impacts both \(\mathbf{y}\) and \(t\).  For fixed step size algorithms
round-off errors in \(t\) may be greatly reduced by computing each \(t\) as a product instead of a running sum.  Here is a glimpse of the impact of step size
on \(t\) round-off:
</p>


<div id="orge272af8" class="figure">
<p><img src="pics/step_too_far_tfit.png" alt="step_too_far_tfit.png" width="90%" align="center" />
</p>
</div>
</div>
</div>
<div id="outline-container-full-code" class="outline-2">
<h2 id="full-code"><span class="section-number-2">2.</span> Full Code Listing</h2>
<div class="outline-text-2" id="text-full-code">
</div>
<div id="outline-container-fortrancode" class="outline-3">
<h3 id="fortrancode"><span class="section-number-3">2.1.</span> Fortran Code</h3>
<div class="outline-text-3" id="text-fortrancode">
<div class="org-src-container">
<pre class="src src-f90"><span style="color: #00ffff;">program</span> <span style="color: #00fa9a; font-weight: bold;">step_too_far</span>

  <span style="color: #00ffff;">use</span> :: mrkiss_config,          <span style="color: #00ffff;">only</span>: rk, istats_size
  <span style="color: #00ffff;">use</span> :: mrkiss_solvers_wt,      <span style="color: #00ffff;">only</span>: fixed_t_steps
  <span style="color: #00ffff;">use</span> :: mrkiss_utils,           <span style="color: #00ffff;">only</span>: print_solution
  <span style="color: #00ffff;">use</span> :: mrkiss_erk_kutta_4,     <span style="color: #00ffff;">only</span>: a, b, c

  <span style="color: #00ffff;">implicit</span> <span style="color: #63b8ff;">none</span>

  <span style="color: #63b8ff;">integer</span>,        <span style="color: #00ffff;">parameter</span> ::<span style="color: #7fffd4;"> deq_dim       = 1</span>
  <span style="color: #63b8ff;">real</span>(kind=rk),  <span style="color: #00ffff;">parameter</span> ::<span style="color: #7fffd4;"> y_iv(deq_dim) = [0.0_rk]</span>
  <span style="color: #63b8ff;">real</span>(kind=rk),  <span style="color: #00ffff;">parameter</span> ::<span style="color: #7fffd4;"> t_iv          = 0.0_rk</span>
  <span style="color: #63b8ff;">real</span>(kind=rk),  <span style="color: #00ffff;">parameter</span> ::<span style="color: #7fffd4;"> param(1)      = [0.0_rk]</span>
  <span style="color: #63b8ff;">real</span>(kind=rk),  <span style="color: #00ffff;">parameter</span> ::<span style="color: #7fffd4;"> t_end         = 1.0_rk</span>

  <span style="color: #63b8ff;">real</span>(kind=rk)             ::<span style="color: #7fffd4;"> solution(1+2*deq_dim, 1)</span>
  <span style="color: #63b8ff;">integer</span>                   ::<span style="color: #7fffd4;"> status, istats(istats_size), sso, num_pts</span>
  <span style="color: #63b8ff;">logical</span>                   ::<span style="color: #7fffd4;"> append</span>

  append = <span style="color: #00ffff;">.false.</span>
  <span style="color: #00ffff;">do</span> sso = 1000,2100
     num_pts = 1.005_rk ** sso
     <span style="color: #00ffff;">print</span> <span style="color: #fa8072;">'("sso=",i4," num_pts=",i0)'</span>, sso, num_pts
     <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">fixed_t_steps</span>(status, istats, solution, eq, t_iv, y_iv, param, a, b, c, max_pts_o=num_pts, t_end_o=t_end)
     <span style="color: #00ffff;">call</span> <span style="color: #00fa9a; font-weight: bold;">print_solution</span>(status, solution, filename_o=<span style="color: #fa8072;">"step_too_far.csv"</span>, tag_o=sso, append_o=append)
     append = <span style="color: #00ffff;">.true.</span>
  <span style="color: #00ffff;">end do</span>

<span style="color: #00ffff;">contains</span>

  <span style="color: #00ffff;">subroutine</span> <span style="color: #00fa9a; font-weight: bold;">eq</span>(status, dydt, t, y, param)
    <span style="color: #63b8ff;">integer</span>,          <span style="color: #00ffff;">intent</span>(out) ::<span style="color: #7fffd4;"> status</span>
    <span style="color: #63b8ff;">real</span>(kind=rk),    <span style="color: #00ffff;">intent</span>(out) ::<span style="color: #7fffd4;"> dydt(:)</span>
    <span style="color: #63b8ff;">real</span>(kind=rk),    <span style="color: #00ffff;">intent</span>(in)  ::<span style="color: #7fffd4;"> t</span>
    <span style="color: #63b8ff;">real</span>(kind=rk),    <span style="color: #00ffff;">intent</span>(in)  ::<span style="color: #7fffd4;"> y(:)</span>
    <span style="color: #63b8ff;">real</span>(kind=rk),    <span style="color: #00ffff;">intent</span>(in)  ::<span style="color: #7fffd4;"> param(:)</span>
    dydt = [ <span style="color: #00ffff;">exp</span>(t) + y(1) ]
    status = 0
  <span style="color: #00ffff;">end subroutine</span> <span style="color: #00fa9a; font-weight: bold;">eq</span>

<span style="color: #00ffff;">end program</span> <span style="color: #00fa9a; font-weight: bold;">step_too_far</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-rcode" class="outline-3">
<h3 id="rcode"><span class="section-number-3">2.2.</span> R Code</h3>
<div class="outline-text-3" id="text-rcode">
<p>
The images were produced with R.
</p>

<div class="org-src-container">
<pre class="src src-R">solDat <span style="color: #8470ff; font-weight: bold;">&lt;-</span> fread(<span style="color: #fa8072;">"step_too_far.csv"</span>) <span style="color: #8470ff; font-weight: bold;">%&gt;%</span>
  mutate(errt   = abs(1-t),
         y      = y1,
         erryat = abs(y-exp(t)),
         erry   = abs(y-exp(1)),
         sso    = tag,
         pts    = 1.005^sso,
         delta  = 1/(pts-1)) <span style="color: #8470ff; font-weight: bold;">%&gt;%</span> 
  filter(errt&gt;0 &amp; erryat&gt;0 &amp; erry&gt;0)

<span style="color: #ffa500;"># </span><span style="color: #ff7f24;">Plot the raw results.</span>
gp <span style="color: #8470ff; font-weight: bold;">&lt;-</span> ggplot(solDat) +
  geom_line( aes(x=delta, y=erry), col=<span style="color: #fa8072;">'indianred3'</span>) +
  geom_point( aes(x=delta, y=erry), col=<span style="color: #fa8072;">'brown4'</span>, size=0.25) +
  scale_y_log10() +
  scale_x_log10() +
  labs(title=<span style="color: #fa8072;">'Accuracy: Step Size Vs. Total Error'</span>, 
       subtitle=<span style="color: #fa8072;">'Experimental results from RK4 '</span>, x=<span style="color: #fa8072;">'Step Size'</span>, y=<span style="color: #fa8072;">'Total Error'</span>)
ggsave(filename=<span style="color: #fa8072;">'step_too_far.png'</span>, plot=gp, width=2*1024, height=1023, units=<span style="color: #fa8072;">'px'</span>, dpi=150)

<span style="color: #ffa500;"># </span><span style="color: #ff7f24;">Compute the log transformed linear regression for the truncation error dominated part of the dataset</span>
treDat <span style="color: #8470ff; font-weight: bold;">&lt;-</span> solDat <span style="color: #8470ff; font-weight: bold;">%&gt;%</span> 
  transmute(x=delta, y=erryat) <span style="color: #8470ff; font-weight: bold;">%&gt;%</span> 
  filter(x&gt;0 &amp; y&gt;0) <span style="color: #8470ff; font-weight: bold;">%&gt;%</span> 
  mutate(xt=log(x), yt=log(y)) <span style="color: #8470ff; font-weight: bold;">%&gt;%</span> 
  filter(x&gt;2e-3)
treFit <span style="color: #8470ff; font-weight: bold;">&lt;-</span> lm(yt ~ xt, data=treDat)     
treDat <span style="color: #8470ff; font-weight: bold;">&lt;-</span> treDat <span style="color: #8470ff; font-weight: bold;">%&gt;%</span> 
  mutate(yf=exp(coef(treFit)[1])*x^(coef(treFit)[2]))

<span style="color: #ffa500;"># </span><span style="color: #ff7f24;">Note the value for 'xt' in the fit will be the order of the RK method used.  </span>
<span style="color: #ffa500;"># </span><span style="color: #ff7f24;">This is a practical way experimentally to compute the order for a RK method.</span>
print(summary(treFit))

<span style="color: #ffa500;">## </span><span style="color: #ff7f24;">ggplot(data=treDat, aes(x=x)) +</span>
<span style="color: #ffa500;">##   </span><span style="color: #ff7f24;">geom_line(aes(y=y), col='red') +</span>
<span style="color: #ffa500;">##   </span><span style="color: #ff7f24;">geom_line(aes(y=yf), col='blue') +</span>
<span style="color: #ffa500;">##   </span><span style="color: #ff7f24;">scale_y_log10() +</span>
<span style="color: #ffa500;">##   </span><span style="color: #ff7f24;">scale_x_log10() </span>

<span style="color: #ffa500;"># </span><span style="color: #ff7f24;">Compute the log transformed linear regression for the round-off error dominated part of the dataset</span>
roeDat <span style="color: #8470ff; font-weight: bold;">&lt;-</span> solDat <span style="color: #8470ff; font-weight: bold;">%&gt;%</span> 
  transmute(x=delta, y=erryat) <span style="color: #8470ff; font-weight: bold;">%&gt;%</span> 
  filter(x&gt;0 &amp; y&gt;0) <span style="color: #8470ff; font-weight: bold;">%&gt;%</span> 
  mutate(xt=log(x), yt=log(y)) <span style="color: #8470ff; font-weight: bold;">%&gt;%</span> 
  filter(x&lt;2e-4)
roeFit <span style="color: #8470ff; font-weight: bold;">&lt;-</span> lm(yt ~ xt, data=roeDat)     
roeDat <span style="color: #8470ff; font-weight: bold;">&lt;-</span> roeDat <span style="color: #8470ff; font-weight: bold;">%&gt;%</span> 
  mutate(yf=exp(coef(roeFit)[1])*x^(coef(roeFit)[2]))

<span style="color: #ffa500;">## </span><span style="color: #ff7f24;">ggplot(data=roeDat, aes(x=x)) +</span>
<span style="color: #ffa500;">##   </span><span style="color: #ff7f24;">geom_line(aes(y=y), col='red') +</span>
<span style="color: #ffa500;">##   </span><span style="color: #ff7f24;">geom_line(aes(y=yf), col='blue') +</span>
<span style="color: #ffa500;">##   </span><span style="color: #ff7f24;">scale_y_log10() +</span>
<span style="color: #ffa500;">##   </span><span style="color: #ff7f24;">scale_x_log10() </span>

gp <span style="color: #8470ff; font-weight: bold;">&lt;-</span> ggplot() + 
  geom_density(data=treDat, aes(x=y-yf, fill=<span style="color: #fa8072;">'Truncation Error'</span>), alpha=0.75, linewidth=0) + 
  geom_density(data=roeDat, aes(x=y-yf, fill=<span style="color: #fa8072;">'Round-off Error'</span>), alpha=0.5, linewidth=0) +
  scale_fill_manual(name=<span style="color: #fa8072;">'Error Type'</span>, 
                      values=c(<span style="color: #fa8072;">'Truncation Error'</span> = <span style="color: #fa8072;">'goldenrod'</span>,
                               <span style="color: #fa8072;">'Round-off Error'</span>  = <span style="color: #fa8072;">'darkolivegreen3'</span>)) +
  labs(title=<span style="color: #fa8072;">'Truncation Vs. Round-off Residual Distribution'</span>, 
       subtitle=<span style="color: #fa8072;">'Experimental results from RK4.'</span>, 
       x=<span style="color: #fa8072;">'Error'</span>, y=<span style="color: #fa8072;">''</span>) +
  theme(axis.text.y=element_blank())
ggsave(filename=<span style="color: #fa8072;">'step_too_far_trdst.png'</span>, plot=gp, width=1024, height=600, units=<span style="color: #fa8072;">'px'</span>, dpi=100)

<span style="color: #ffa500;"># </span><span style="color: #ff7f24;">Add total, truncation, round-off error to our solution data and plot everything.</span>
solDat <span style="color: #8470ff; font-weight: bold;">&lt;-</span> solDat <span style="color: #8470ff; font-weight: bold;">%&gt;%</span> mutate(erryattre=exp(coef(treFit)[1])*delta^(coef(treFit)[2]),
                            erryatroe=exp(coef(roeFit)[1])*delta^(coef(roeFit)[2]),
                            erryattoe=erryattre+erryatroe)

gp <span style="color: #8470ff; font-weight: bold;">&lt;-</span> ggplot(data=solDat, aes(x=delta)) +
  geom_line(aes(y=erryattre, col=<span style="color: #fa8072;">'Mean Truncation Error'</span>), linewidth=5, alpha=0.7) +
  geom_line(aes(y=erryatroe, col=<span style="color: #fa8072;">'Mean Round-off Error'</span>), linewidth=5, alpha=0.7) +
  geom_line(aes(y=erryattoe, col=<span style="color: #fa8072;">'Mean Total Error'</span>), linewidth=3) +
  geom_point(aes(y=erryat, col=<span style="color: #fa8072;">'Total Error'</span>), size=0.5) +
  scale_y_log10(limits=range(solDat$erryat)) +
  scale_x_log10() +
  scale_colour_manual(name=<span style="color: #fa8072;">'Error Type'</span>, 
                      values=c(<span style="color: #fa8072;">'Mean Total Error'</span>      = <span style="color: #fa8072;">'darkorchid3'</span>,
                               <span style="color: #fa8072;">'Mean Truncation Error'</span> = <span style="color: #fa8072;">'goldenrod'</span>,
                               <span style="color: #fa8072;">'Mean Round-off Error'</span>  = <span style="color: #fa8072;">'darkolivegreen3'</span>,                               
                               <span style="color: #fa8072;">'Total Error'</span>           = <span style="color: #fa8072;">'indianred3'</span>)) +
  labs(title=<span style="color: #fa8072;">'Error Vs. Step Size'</span>, 
       subtitle=<span style="color: #fa8072;">'Experimental results from RK4 illustrating total error as a sum of round-off and truncation errors.'</span>, 
       x=<span style="color: #fa8072;">'Step Size'</span>, y=<span style="color: #fa8072;">'Errors'</span>)
ggsave(filename=<span style="color: #fa8072;">'step_too_far_mean.png'</span>, plot=gp, width=1024, height=600, units=<span style="color: #fa8072;">'px'</span>, dpi=100)

<span style="color: #ffa500;"># </span><span style="color: #ff7f24;">Compute the log transformed linear regression for t</span>
troeDat <span style="color: #8470ff; font-weight: bold;">&lt;-</span> solDat <span style="color: #8470ff; font-weight: bold;">%&gt;%</span> 
  transmute(x=delta, y=errt) <span style="color: #8470ff; font-weight: bold;">%&gt;%</span> 
  filter(x&gt;0 &amp; y&gt;0) <span style="color: #8470ff; font-weight: bold;">%&gt;%</span> 
  mutate(xt=log(x), yt=log(y))
troeFit <span style="color: #8470ff; font-weight: bold;">&lt;-</span> lm(yt ~ xt, data=troeDat)     
troeDat <span style="color: #8470ff; font-weight: bold;">&lt;-</span> troeDat <span style="color: #8470ff; font-weight: bold;">%&gt;%</span> 
  mutate(yf=exp(coef(troeFit)[1])*x^(coef(troeFit)[2]))

gp <span style="color: #8470ff; font-weight: bold;">&lt;-</span> ggplot(data=troeDat, aes(x=x)) +
  geom_line(aes(y=yf, col=<span style="color: #fa8072;">'Mean Round-off Error'</span>), alpha=0.7, linewidth=10) +
  geom_point(aes(y=y, col=<span style="color: #fa8072;">'Total Error'</span>), size=0.5) +
  scale_y_log10() +
  scale_x_log10() +
  scale_colour_manual(name=<span style="color: #fa8072;">'Error Type'</span>, 
                      values=c(<span style="color: #fa8072;">'Mean Round-off Error'</span>  = <span style="color: #fa8072;">'darkolivegreen3'</span>,                               
                               <span style="color: #fa8072;">'Total Error'</span>           = <span style="color: #fa8072;">'indianred3'</span>)) +
  labs(title=<span style="color: #fa8072;">'Independent Variable Error Vs. Step Size'</span>, 
       subtitle=<span style="color: #fa8072;">'Experimental results from RK4.'</span>, 
       x=<span style="color: #fa8072;">'Step Size'</span>, y=<span style="color: #fa8072;">'Errors'</span>)
ggsave(filename=<span style="color: #fa8072;">'step_too_far_tfit.png'</span>, plot=gp, width=1024, height=600, units=<span style="color: #fa8072;">'px'</span>, dpi=100)

</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br />
<br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br />
<br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br />
<br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br />
<br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br />
</div>
</body>
</html>
